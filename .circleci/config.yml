version: 2
jobs:
  build:
    docker:
      - image: cimg/node:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Copy env file
          command: cp .env.ci .env
      - run:
          name: build containers
          command: make build
      - run:
          name: install npm packages
          command: npm ci
      - run:
          name: build webpack
          command: npm run build
      - run:
          name: check for missing migrations
          command: make checkmigrations
      - run:
          name: run containers
          command: docker-compose --profile selenium up -d
  lint:
    steps:
      - checkout
      - run:
          name: Check for fixme comments
          command: make check-fixme
      - run:
          name: run black (code formatting check)
          command: make black-check
      - run:
          name: run isort
          command: make isort-check
      - run:
          name: run flake8 (coding standards compliance test)
          command: make flake8
  unit-tests:
    steps:
      - checkout
      - run:
          name: run all tests
          command: make test
      - run:
          name: Publish unit test coverage
          command: |
            wget -O codecov.sh https://codecov.io/bash
            bash ./codecov.sh -t ${CODECOV_TOKEN} -s test-reports -f "*.xml"
  e2e-tests:
    steps:
      - checkout
      - run:
          name: run all tests
          command: make test-selenium
      - run:
          name: Publish unit test coverage
          command: |
            wget -O codecov.sh https://codecov.io/bash
            bash ./codecov.sh -t ${CODECOV_TOKEN} -s test-reports -f "*.xml"

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - lint:
          requires:
            - build
      - unit-tests:
          requires:
            - build
      - e2e-tests:
          filters:
            branches:
              only:
                - main
                - master
          requires:
            - build
